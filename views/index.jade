extends layout

block content
  style
    html, body {
      width:  100%;
      height: 100%;
    }
    body {
      margin: 0px;
      padding: 0px;
    }
    #radar {
      background: white;
      position:fixed;
      width: 864px;
      heigh: 694px;
      left: 50%;
      margin-left: -432px;
      margin-top: -20px;
    }
    .content{
      margin-top: 40px;
    }

    .hidden{
      display: none;
    }
    #intro, #replay{
      margin-left: 300px;
      padding-top: 20px;
    }
    #play{
      padding: 100px;
      font-size: 100pt;
    }
  //- canvas#background
  ul.content.unstyled
    li#intro
      button#play.btn.btn-info.btn-large(type="submit")
        | Play

    li#game.hidden
      #radar

    li#result.hidden
      #description.lead
        h1 Congratulations: You have won!
        p
          | Please approach a ThoughtWorker to collect your Tech Radar T-shirt.
          img(src="tshirt.jpg")
        p
          | If you wish to sign up to ThoughtWorks Technology Radar Publication (released twice a year) and get into the draw to win a macbook air, please enter your details below:
          img(src="macbookair.png", width="160", height="90")

      #form
        form#signup(action="/punters", method="POST")
          div.field
            input#full-name(placeholder="Full Name", type="text",name="fullName", required="true")
          div.field
            input#company(placeholder="Company", type="text", name="company", required="true")
          div.field
            input#email(placeholder="Email", type="email", name="emailAddress", required="true")
          button.btn.btn-success.btn-large(type="submit")
            | Sign up
        form#skip
          button.btn.btn-warning.btn-large(type="submit")
            | I don't want to sign up

    li#replay.hidden
      h1 Thanks for playing! 
      p This page will self-destruct in 
        span.countdown ... 
        |  seconds...




block javascript_content
  script(src="/bootstrap/js/bootstrap.js")
  script(src="http://www.html5canvastutorials.com/libraries/kinetic-v4.0.3.js")
  script(src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js")
  script(src="/jquery-timeout-read-only/jquery.timeout.js")
  //- script(src="http://remote-tilt.com/js/device-motion-polyfill.js?key=tw_yow_game")
  script(src="canvg-1.2/rgbcolor.js")
  script(src="canvg-1.2/canvg.js")

  != js('radar')
  != js('marble')
  != js('technology_generator')
  != js('game_timer')
  != js('hole')
  != js('signup')

  script
    $(function() { 
      var game_countdown = 5;
      var replay_countdown = 5;

      var play_phase = function(data) {
        defer = new $.Deferred
        $('#play').click(function(){
          $('#game,#intro').toggleClass('hidden')
           new Radar({
             width: 864,
             height: 694,
             data: data,
             containerId: 'radar',
             background_svg : 'radar.svg',
             duration: game_countdown
           }).play().
            done( function(){ defer.resolve() } ).
            fail( function(){ defer.reject() } );
        });
        return defer;
      };

      var signup_phase = function(){
        $('#game,#result').toggleClass('hidden')
        return new Signup({containerId: 'form'}).capture()      
      };

      var replay_phase = function(){
        $('#result, #replay').toggleClass('hidden')
        var tick = function(delay){
          return $.timeout(1000, delay-1).pipe(function(remaining){
            $('#replay .countdown').text(remaining + ' ');
            return tick(remaining);
          })
        }
        tick(replay_countdown);
        return $.timeout(replay_countdown*1000);
      };

      $.getJSON('/data')
        .pipe( play_phase )
        .pipe( signup_phase )
        .pipe( replay_phase )
        .pipe( function(){ location.reload(); });
    });
