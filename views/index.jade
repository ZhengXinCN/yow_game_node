extends layout

block content
  style
    html, body {
      width:  100%;
      height: 100%;
    }
    body {
      margin: 0px;
      padding: 0px;
    }
    #radar {
      background: white;
      position:fixed;
      width: 864px;
      height: 694px;
      left: 50%;
      margin-left: -432px;
      margin-top: -20px;
    }
    .content{
      margin-top: 40px;
    }

    .hidden{
      display: none;
    }

    .hero-unit {
      color: white;
      background-color: #49AFCD;
    }

    //- #intro {
    //-   padding-top: 50px;
    //- }
    #intro #play {
      padding: 30px;
      font-size: 100pt;
    }
    #intro #instructions {
      padding-top: 50px;
    }

    .retro {
      font-family: delusion;
      text-transform: uppercase;
    }
    #replay{
      margin-left: 300px;
      padding-top: 20px;
    }
  //- canvas#background
  ul.tw.content.unstyled
    li#intro
      .row
        .hero-unit
          h1 Technology Radar Game
          p The 
            strong Thoughtworks 
            | Technology Radar is published every six months.  
          p To celebrate this summer's edition we invite you to show your grasp on current trends of technology adoption.

      .row
        .span4.offset2
          ul#instructions.unstyled
            li
              a(href="#") Get the technology into it's right place on the radar
            li
              a(href="#") Tilt the ipad to move
            li
              a(href="#") Avoid the obstacles
            li
              a(href="#") Winners can enter the draw for some goodies.
            li
              a(href="#") You have 30 seconds to do as many as you can.
            li
              a(href="#") Press "Play!" to start
        .span4.offset1
          button#play.btn.btn-info.btn-large(type="submit")
            | Play

    li#game.hidden
      #radar

    li#result.hidden
      .offset2
        .row.retro
          h1 Game Over!
        .row.retro
          p.span2 Your Score: 
          p.span1.score 0
        .row.retro
          p.span2 Your Rating: 
          p.span1 Novice
        .row.retro
          p.span2 You win: 
          p.span1 
            img(src="tshirt.jpg")
        .row
          p 
            | To claim your prize, and a 
            b free 
            | subscription to the ThoughtWorks Technology Radar publication:

        .row
          p.span2 
            i.icon-eye-open
            | Find Natalie
          p.span2 
            i.icon-qrcode
            | Scan your QR code
          p.span2 
            i.icon-retweet
            | Tweet your score on #twradargame
        .row
          p.retro This page will self-destruct in 
            span.countdown ... 
            |  seconds...

      //- #form
      //-   form#signup(action="/punters", method="POST")
      //-     div.field
      //-       input#full-name(placeholder="Full Name", type="text",name="fullName", required="true")
      //-     div.field
      //-       input#company(placeholder="Company", type="text", name="company", required="true")
      //-     div.field
      //-       input#email(placeholder="Email", type="email", name="emailAddress", required="true")
      //-     button.btn.btn-success.btn-large(type="submit")
      //-       | Sign up
      //-   form#skip
      //-     button.btn.btn-warning.btn-large(type="submit")
      //-       | I don't want to sign up

    li#replay.hidden




block javascript_content
  script(src="/bootstrap/js/bootstrap.js")
  script(src="http://www.html5canvastutorials.com/libraries/kinetic-v4.0.3.js")
  script(src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js")
  script(src="/jquery-timeout-read-only/jquery.timeout.js")
  //- script(src="http://remote-tilt.com/js/device-motion-polyfill.js?key=tw_yow_game")
  script(src="canvg-1.2/rgbcolor.js")
  script(src="canvg-1.2/canvg.js")

  != js('radar')
  != js('marble')
  != js('technology_generator')
  != js('game_timer')
  != js('hole')
  != js('signup')

  script
    $(function() { 
      var game_countdown = 5;
      var replay_countdown = 5;

      var intro_phase = function(data){
        defer = new $.Deferred
        $('#play').click(function(){
          defer.resolve(data);
        });
        return defer;
      }

      var play_phase = function(data){
        return new Radar({
           width: 864,
           height: 694,
           data: data,
           containerId: 'radar',
           background_svg : 'radar.svg',
           duration: game_countdown
         }).play();
      }

      var transition = function(selectors){
        return function(data){
          $(selectors).toggleClass('hidden')
          return data;
        }
      }

      var signup_phase = function(){
        return new Signup({containerId: 'form'}).capture()      
      };

      var replay_phase = function(options){
        var tick = function(delay){
          return $.timeout(1000, delay-1).pipe(function(remaining){
            $( options.countdownSelector || '.countdown').text(remaining + ' ');
            return tick(remaining);
          })
        }

        var duration = options.replay_countdown || 15;
        tick(duration);
        return $.timeout(duration*1000);
      };

      $.getJSON('/data')
        .pipe( intro_phase )
        .pipe( transition('#intro,#game') )
        .pipe( play_phase )
        .pipe( transition('#game,#result'))
        //- .pipe( signup_phase )
        //- .pipe( transition('#result,#replay'))
        .pipe( replay_phase.bind(this,{
            duration: replay_countdown
          , countdownSelector:'#result .countdown'
        }))
        .pipe( function(){ location.reload(); });
    });
